<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lead Sheet Generator - Druckoptimiert</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Roboto:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@400;700&family=Caveat:wght@400;700&family=Noto+Music&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      /* Grundlegende Zurücksetzung & Globale Stile */
      :root {
        --background-color: #ffffff;
        --text-color: #1c1e21;
        --primary-color: #007bff;
        --danger-color: #dc3545;
        --border-color: #d1d5db;
        --sheet-font: 'Times New Roman', Times, serif;
        --chord-font: 'Oswald', sans-serif;
        --ui-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        --bar-line-width: 30px;

        /* Farben für interaktive Flächen */
        --interactive-color-header: rgba(253, 253, 150, 0.25);
        --interactive-color-time: rgba(255, 204, 153, 0.25);
        --interactive-color-linetext: rgba(193, 225, 193, 0.25);
        --interactive-color-measure: rgba(255, 209, 220, 0.25);
        --interactive-color-barline: rgba(195, 177, 225, 0.25);
        --interactive-color-volta: rgba(255, 179, 71, 0.2);

        --interactive-color-header-hover: rgba(253, 253, 150, 0.45);
        --interactive-color-time-hover: rgba(255, 204, 153, 0.45);
        --interactive-color-linetext-hover: rgba(193, 225, 193, 0.45);
        --interactive-color-measure-hover: rgba(255, 209, 220, 0.45);
        --interactive-color-barline-hover: rgba(195, 177, 225, 0.45);
        --interactive-color-volta-hover: rgba(255, 179, 71, 0.4);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--ui-font);
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      /* App-Layout */
      .app-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding: 2rem;
      }

      .main-content {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      /* Notenblatt-Panel */
      .sheet-panel {
        position: relative;
        width: 100%;
        max-width: 900px;
      }

      .sheet-music {
        background-color: white;
        padding: 20px;
        width: 100%;
        aspect-ratio: 210 / 297;
        height: auto;
        border: 1px solid var(--border-color);
        font-family: var(--sheet-font);
        margin-top: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      /* Header Editor Toolbar */
      .header-editor-toolbar {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 1rem;
        padding: 0.5rem 1rem;
        margin-top: 130px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        z-index: 200;
        border: 1px solid var(--border-color);
        transition: opacity 0.2s, visibility 0.2s;
      }

      .header-editor-toolbar.hidden {
        opacity: 0;
        visibility: hidden;
      }

      .toolbar-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .toolbar-group label {
        font-size: 0.9rem;
        color: #555;
      }

      .toolbar-group select, .toolbar-group input {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        font-family: var(--ui-font);
        font-size: 0.9rem;
      }

      .toolbar-group input[type="number"] {
        width: 60px;
      }

      /* Header Styles */
      .sheet-header {
        margin-bottom: 2rem;
        border-bottom: 2px solid black;
        padding-bottom: 1rem;
      }

      .sheet-header h1, .sheet-header .title-input {
        font-weight: bold;
        text-align: center;
        margin-bottom: 0.5rem;
        cursor: pointer;
        line-height: 1.2;
      }

      .sheet-header h1, .style-info, .subtitle-info {
        padding: 0.25rem;
        border-radius: 4px;
      }

      .header-second-line {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        line-height: 1.2;
      }

      .style-info, .subtitle-info {
        cursor: pointer;
        width: 50%;
      }

      .subtitle-info {
        text-align: right;
      }

      /* Edit Mode Styles for Header */
      .header-input {
        width: 100%;
        border: none;
        border-radius: 4px;
        background-color: #e9ecef;
        padding: 0.25rem;
      }
      .header-input.title-input {
          font-weight: bold;
          text-align: center;
      }
      .header-input.subtitle-input {
          text-align: right;
      }

      /* Sheet Body & Time Signature */
      .sheet-body {
        position: relative;
      }

      .time-signature {
        position: absolute;
        left: 0px;
        top: 0;
        font-size: 2rem;
        font-weight: bold;
        line-height: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        padding: 42px 6px 6px 6px;
        border-radius: 4px;
        width: 60px;
      }

      .time-signature-input {
          width: 100%;
          font-size: 2rem;
          text-align: center;
          border: none;
          background-color: #e9ecef;
          font-family: var(--sheet-font);
          font-weight: bold;
      }

      .measures-container {
          padding-left: 80px;
      }

      /* Line Text Styles */
      .line-wrapper {
        margin: 0;
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 1rem;
      }

      .line-text-container {
        margin-bottom: 0.75rem;
        padding: 4px;
        cursor: pointer;
        border-radius: 4px;
        min-height: 2em;
      }
      
      .line-text-display {
        font-style: italic;
        font-size: 1.5rem;
        color: #000;
        min-height: 1.8em;
        line-height: 1.3;
      }
      
      .line-text-display.align-left {
          text-align: left;
          padding-left: 15px;
      }
      .line-text-display.align-center {
          text-align: center;
      }
      .line-text-display.align-right {
          text-align: right;
          padding-right: 15px;
      }
      
      .line-text-display:empty::before {
          content: ' ';
          white-space: pre;
      }

      .musical-symbol {
        font-family: 'Noto Music', sans-serif;
        font-style: normal;
        font-weight: normal;
        vertical-align: middle;
        margin: 0 0.2em;
        display: inline-block;
        line-height: 0;
      }

      .segno-symbol {
        font-size: 1.5em;
        position: relative;
        top: -0.05em;
      }

      .coda-symbol {
        font-size: 1.6em;
        position: relative;
        top: 0.1em;
      }

      .ds-symbol, .dc-symbol {
        font-size: 1.6em;
        position: relative;
        top: 0.1em;
        font-weight: normal;
      }

      .line-text-input {
        width: 100%;
        border: none;
        border-radius: 4px;
        background-color: #e9ecef;
        font-family: var(--sheet-font);
        font-style: italic;
        font-size: 1.5rem;
        padding: 0.5rem;
      }

      .line-text-container:has(.line-text-input) {
          margin-bottom: 35px;
          position: relative;
          z-index: 7;
      }

      /* Measure & Bar Lines Layout */
      .measure-line {
        display: flex;
        width: 100%;
        align-items: stretch;
        position: relative;
        justify-content: flex-start;
        margin-bottom: 1rem;
      }

      .measure {
        flex-grow: 0;
        flex-shrink: 0;
        flex-basis: calc((100% - (5 * var(--bar-line-width))) / 4);
        display: flex;
        align-items: flex-end;
        font-size: 2.5rem;
        font-weight: normal;
        position: relative;
        min-height: 60px;
        cursor: pointer;
        padding: 8px;
        font-family: var(--chord-font);
        border-radius: 4px;
      }

      /* Bar Line Containers and Display */
      .bar-line-container {
          flex-shrink: 0;
          width: var(--bar-line-width);
          display: flex;
          justify-content: center;
          align-items: center;
          cursor: pointer;
          position: relative;
          border-radius: 4px;
          min-height: 60px;
      }

      .bar-line-display {
          height: 100%;
          position: relative;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      /* Visual Bar Lines - optimized for print */
      .bar-line-display::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 10%;
        bottom: 10%;
        transform: translateX(-50%);
        box-sizing: border-box;
      }
      .bar-line-display.bar-single::after {
        width: 0;
        border-left: 2px solid black;
      }
      .bar-line-display.bar-double::after {
        width: 6px;
        border-left: 2px solid black;
        border-right: 2px solid black;
      }
      .bar-line-display.bar-end::after, .bar-line-display.bar-final::after {
        width: 8px;
        border-left: 2px solid black;
        border-right: 4px solid black;
      }
      .bar-line-display.bar-end::before {
          content: ':';
          position: absolute;
          right: 8px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 1.8rem;
          color: black;
          font-weight: bold;
      }
      .bar-line-display.bar-start-repeat::after {
        width: 8px;
        border-left: 4px solid black;
        border-right: 2px solid black;
      }
      .start-repeat-dots {
          position: absolute;
          left: 8px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 1.8rem;
          color: black;
          font-weight: bold;
      }

      /* Bar Line Editor */
      .bar-line-input {
          width: 100%;
          height: 80%;
          text-align: center;
          border: none;
          background-color: #e9ecef;
          font-family: monospace;
          font-size: 1.2rem;
          border-radius: 4px;
      }

      /* Rehearsal Marks */
      .rehearsal-mark-container {
        position: absolute;
        bottom: 100%;
        margin-bottom: 8px;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        z-index: 5;
      }

      .rehearsal-mark {
        display: inline-block;
        padding: 0.3em 0.6em;
        border: 2px solid black;
        background-color: white;
        font-size: 1.2rem;
        font-weight: bold;
        line-height: 1;
        cursor: pointer;
        border-radius: 2px;
      }

      .rehearsal-mark-input {
        border: none;
        border-radius: 4px;
        background-color: #e9ecef;
        text-align: center;
        font-family: var(--sheet-font);
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--text-color);
        padding: 0.3rem;
        width: 120px;
      }

      /* Volta Brackets (Endings) */
      .volta-container {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        height: 30px;
        cursor: pointer;
        margin-bottom: 20px;
        z-index: 6;
        transition: background-color 0.2s ease;
        border-radius: 4px;
      }

      .volta-input {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 4px;
        background-color: #e9ecef;
        text-align: center;
        font-family: var(--sheet-font);
        font-size: 1rem;
        font-weight: bold;
        padding: 0.25rem;
      }

      .volta-display {
          position: absolute;
          bottom: 0;
          height: 100%;
          width: 100%;
          pointer-events: none;
      }

      .volta-line {
          position: absolute;
          top: 0;
          height: 0;
          border-top: 2px solid black;
      }

      .volta-line.starts-here {
          left: -16px;
      }
      .volta-line.continues {
          left: -16px;
      }

      .volta-line.ends-here {
          right: -16px;
      }
      .volta-line.continues-past {
          right: -16px;
      }

      .volta-hook {
          position: absolute;
          top: 0;
          width: 0;
          height: 25px;
          border-left: 2px solid black;
      }

      .volta-start-hook {
          left: -16px;
      }

      .volta-end-hook {
          right: -16px;
      }

      .volta-text {
          position: absolute;
          top: 3px;
          left: -8px;
          font-family: var(--sheet-font);
          font-size: 1.1rem;
          font-weight: bold;
          color: black;
      }

      /* Chord Display Styles */
      .beats-display {
          display: flex;
          width: 100%;
          align-items: flex-end;
          min-height: 40px;
      }
      .beat-slot {
          flex: 1;
          min-height: 1.5em;
          padding: 0 4px;
          line-height: 1;
          display: flex;
          justify-content: center;
          align-items: flex-end;
      }
      .beat-slash {
          font-family: 'Noto Music', sans-serif;
          font-size: 2.8rem;
          color: #000;
          font-weight: normal;
          position: relative;
          top: 0.2em;
          line-height: 1;
      }
      .chord-display {
          display: inline-flex;
          flex-direction: row;
          align-items: baseline;
          line-height: 1;
          font-family: var(--chord-font);
      }
      .chord-main { }
      .chord-root-slash {
          vertical-align: super;
          font-size: 0.6em;
          line-height: 0;
      }
      .chord-bass {
          vertical-align: sub;
          font-size: 0.6em;
          line-height: 0;
          margin-left: 1px;
          padding-top: 10px;
      }
      .chord-accidental {
          font-family: 'Noto Music', sans-serif;
          font-size: 0.8em;
          font-weight: normal;
          vertical-align: super;
          margin-left: 1px;
          line-height: 0;
      }
      .chord-accidental.is-flat {
        font-size: 0.95em;
        position: relative;
        top: 0.05em;
      }
      .chord-extension {
          font-size: 0.5em;
          font-weight: normal;
          vertical-align: top;
          margin-left: 2px;
      }
      .chord-extension.is-slash-extension {
          vertical-align: super;
          font-size: 0.6em;
          line-height: 0;
      }

      /* Taktwiederholungszeichen (Faulenzer) */
      .lazy-symbol-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        min-height: 60px;
      }

      .lazy-symbol {
        font-family: 'Noto Music', sans-serif;
        font-size: 3.5rem;
        line-height: 1;
        font-weight: normal;
        color: #000;
      }

      /* Measure Editor */
      .measure-editor {
          display: flex;
          width: 100%;
          height: 100%;
          padding: 4px;
          gap: 4px;
      }
      .beat-input {
          flex: 1;
          width: 100%;
          border: none;
          border-radius: 4px;
          background-color: #e9ecef;
          text-align: center;
          font-family: var(--chord-font);
          font-size: 1.8rem;
          font-weight: normal;
          color: var(--text-color);
          padding: 0.25rem;
          min-width: 3em;
      }

      /* Focus Styles */
      .header-input:focus, .time-signature-input:focus, .beat-input:focus, .bar-line-input:focus, .rehearsal-mark-input:focus, .line-text-input:focus, .volta-input:focus {
        outline: 2px solid var(--primary-color);
        background-color: #fff;
        z-index: 10;
      }

      /* Hervorhebung interaktiver Flächen */
      .sheet-header h1, .style-info, .subtitle-info,
      .time-signature,
      .line-text-container,
      .measure,
      .bar-line-container,
      .volta-container {
          transition: background-color 0.2s ease-in-out;
      }

      /* Header Parts */
      .sheet-header h1, .style-info, .subtitle-info {
          background-color: var(--interactive-color-header);
      }
      .sheet-header h1:hover, .style-info:hover, .subtitle-info:hover {
          background-color: var(--interactive-color-header-hover);
      }

      /* Time Signature */
      .time-signature {
          background-color: var(--interactive-color-time);
      }
      .time-signature:hover {
          background-color: var(--interactive-color-time-hover);
      }

      /* Line Text */
      .line-text-container {
          background-color: var(--interactive-color-linetext);
      }
      .line-text-container:hover {
          background-color: var(--interactive-color-linetext-hover);
      }

      /* Measures */
      .measure {
          background-color: var(--interactive-color-measure);
      }
      .measure:hover {
          background-color: var(--interactive-color-measure-hover);
      }

      /* Bar Lines */
      .bar-line-container {
          background-color: var(--interactive-color-barline);
      }
      .bar-line-container:hover {
          background-color: var(--interactive-color-barline-hover);
      }

      /* Volta Brackets */
      .volta-container {
          background-color: var(--interactive-color-volta);
      }
      .volta-container:hover {
          background-color: var(--interactive-color-volta-hover);
      }

      /* App Buttons */
      .app-button {
        position: fixed;
        bottom: 20px;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        background-color: var(--primary-color);
        border: none;
        border-radius: 6px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: all 0.2s;
        z-index: 100;
      }
      .app-button:hover:not(:disabled) { background-color: #0069d9; }
      .app-button:disabled { opacity: 0.6; cursor: not-allowed; }

      .export-button {
        right: 20px;
      }

      .print-button {
        right: 200px;
      }

      .help-button {
          left: 150px;
          padding: 0.75rem 1rem;
          font-size: 1.2rem;
      }

      .add-line-button {
        left: 20px;
      }

      .line-delete-btn {
        flex-shrink: 0;
        align-self: center;
        margin-left: 10px;
        background: transparent;
        border: none;
        font-family: var(--ui-font);
        font-size: 2rem;
        font-weight: 300;
        color: #000;
        cursor: pointer;
        line-height: 1;
        padding: 0 5px;
        transition: color 0.2s ease;
      }

      .line-delete-btn:hover {
        color: var(--danger-color);
      }

      .measure-delete-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 20px;
        height: 20px;
        background: transparent;
        border: none;
        font-family: var(--ui-font);
        font-size: 1.5rem;
        font-weight: 300;
        color: #aaa;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease, transform 0.2s ease;
        z-index: 15;
      }

      .measure-delete-btn:hover {
        color: var(--danger-color);
        transform: scale(1.1);
      }

      .add-measure-btn {
          flex-grow: 0;
          flex-shrink: 0;
          flex-basis: calc((100% - (5 * var(--bar-line-width))) / 4);
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 60px;
          cursor: pointer;
          padding: 5px;
          border: 2px dashed var(--border-color);
          border-radius: 4px;
          color: #c1c5cb;
          font-size: 2.5rem;
          background-color: transparent;
          transition: all 0.2s ease;
          margin-left: 5px;
      }
      .add-measure-btn:hover {
          color: #555;
          border-color: #555;
          background-color: #f8f9fa;
      }

      /* Modal Styles */
      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.6);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
      }

      .modal-overlay.hidden {
          display: none;
      }

      .modal-content {
          background-color: #fff;
          padding: 2rem;
          border-radius: 8px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          width: 90%;
          max-width: 650px;
          max-height: 90vh;
          overflow-y: auto;
          position: relative;
      }

      .modal-close-btn {
          position: absolute;
          top: 10px;
          right: 15px;
          background: none;
          border: none;
          font-size: 2rem;
          line-height: 1;
          cursor: pointer;
          color: #888;
      }

      .modal-content h2 {
          margin-top: 0;
          margin-bottom: 1rem;
          border-bottom: 1px solid #eee;
          padding-bottom: 0.5rem;
      }

      .modal-content dl {
          margin-top: 1rem;
      }

      .modal-content dt {
          font-weight: bold;
          margin-top: 1rem;
      }

      .modal-content dd {
          margin-left: 1.5rem;
          margin-bottom: 0.5rem;
      }

      .modal-content ul {
          list-style: none;
          padding-left: 0;
      }

      .modal-content code {
          background-color: #eee;
          padding: 2px 4px;
          border-radius: 4px;
          font-family: monospace;
      }

      /* Export-spezifische Styles - versteckt interaktive Elemente */
      body.is-exporting .measure-delete-btn,
      body.is-exporting .line-delete-btn,
      body.is-exporting .add-measure-btn,
      body.is-exporting .header-editor-toolbar {
          display: none !important;
      }

      body.is-exporting .sheet-header h1,
      body.is-exporting .style-info,
      body.is-exporting .subtitle-info,
      body.is-exporting .time-signature,
      body.is-exporting .line-text-container,
      body.is-exporting .measure,
      body.is-exporting .bar-line-container,
      body.is-exporting .volta-container {
          background-color: transparent !important;
      }

      /* Print Logic Support */
      #print-container {
        display: none;
      }

      body.is-printing > .app-container {
        display: none;
      }

      body.is-printing #print-container {
        display: block;
      }

      /* Optimierte Print Styles */
      @media print {
        body {
          background-color: #fff !important;
          color: #000 !important;
          font-size: 12pt;
          line-height: 1.4;
          margin: 0;
          padding: 0;
        }

        @page {
          size: A4;
          margin: 15mm 10mm;
        }
        
        /* Verstecke alle interaktiven UI-Elemente */
        .app-button, 
        .header-editor-toolbar, 
        .measure-delete-btn, 
        .line-delete-btn, 
        .add-measure-btn {
          display: none !important;
        }
        
        /* Entferne interaktive Hintergründe */
        .print-page .sheet-header h1,
        .print-page .style-info,
        .print-page .subtitle-info,
        .print-page .time-signature,
        .print-page .line-text-container,
        .print-page .measure,
        .print-page .bar-line-container,
        .print-page .volta-container {
            background-color: transparent !important;
        }

        .print-page {
          width: 100%;
          height: auto;
          min-height: calc(297mm - 30mm);
          page-break-after: always;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          background: white !important;
          color: black !important;
          font-family: 'Times New Roman', serif;
          padding: 10mm;
        }

        .print-page:last-child {
          page-break-after: auto;
        }
        
        .page-content-wrapper {
          flex: 1;
          position: relative;
        }

        .page-footer {
          text-align: center;
          font-size: 10pt;
          padding: 1rem 0 0 0;
          margin-top: auto;
          border-top: 1px solid #ccc;
          color: #666;
        }

        /* Print-spezifische Typographie */
        .print-page .sheet-header {
            background: transparent !important;
            box-shadow: none !important;
            border-bottom: 2px solid black !important;
            padding: 0 0 1rem 0;
            margin-bottom: 1.5rem;
        }

        .print-page .sheet-body {
            background: transparent !important;
            padding: 0;
        }

        .print-page .sheet-header h1 {
          font-size: 20pt !important;
          font-weight: bold;
          text-align: center;
          margin-bottom: 0.5rem;
          color: black !important;
        }

        .print-page .header-second-line {
          font-size: 11pt !important;
        }

        .print-page .time-signature {
          font-size: 16pt !important;
          color: black !important;
          width: 50px;
          padding: 0;
        }

        .print-page .line-text-display {
          font-size: 10pt !important;
          font-style: italic;
          color: black !important;
          margin-bottom: 0.4rem;
          min-height: auto;
        }

        .print-page .chord-display {
          font-size: 12pt !important;
          color: black !important;
        }

        .print-page .beat-slash {
          color: black !important;
          font-size: 14pt !important;
        }

        .print-page .lazy-symbol {
          color: black !important;
          font-size: 24pt !important;
        }

        .print-page .rehearsal-mark {
          background-color: white !important;
          border: 2px solid black !important;
          font-size: 9pt !important;
          font-weight: bold;
          padding: 0.2em 0.4em;
          color: black !important;
        }

        .print-page .volta-line,
        .print-page .volta-hook {
          border-color: black !important;
        }

        .print-page .volta-text {
          color: black !important;
          font-size: 9pt !important;
          font-weight: bold !important;
        }

        .print-page .musical-symbol {
          color: black !important;
        }

        /* Verhindere Zeilen-Umbrüche über Seiten */
        .print-page .line-wrapper {
          break-inside: avoid;
          page-break-inside: avoid;
          margin-bottom: 0.8rem;
        }

        .print-page .measure-line {
          margin-bottom: 0.6rem;
        }

        /* Stelle sicher, dass Taktstriche korrekt drucken */
        .print-page .bar-line-display::after, 
        .print-page .bar-line-display::before, 
        .print-page .start-repeat-dots {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color: black !important;
          border-color: black !important;
        }
        
        /* Force konsistentes Font-Rendering */
        .print-page * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        /* Optimiere Spacing für Druck */
        .print-page .measures-container {
          padding-left: 60px;
        }

        .print-page .measure {
          font-size: 14pt !important;
          min-height: 45px;
          padding: 4px;
        }

        .print-page .bar-line-container {
          width: 20px;
          min-height: 45px;
        }

        .print-page .bar-line-display::after {
          top: 15%;
          bottom: 15%;
        }
      }

      /* High contrast mode für bessere Lesbarkeit */
      @media print and (prefers-contrast: high) {
        .print-page .beat-slash {
          color: black !important;
        }
        
        .print-page .bar-line-display::after,
        .print-page .bar-line-display::before {
          border-color: black !important;
        }
      }
    </style>
</head>
  <body>
    <noscript>Sie müssen JavaScript aktivieren, um diese App zu verwenden.</noscript>
    
    <div class="app-container">
      <main class="main-content">
        <div class="sheet-panel" aria-label="Lead Sheet Preview">
          
          <!-- Header Editor Toolbar -->
          <div id="header-editor-toolbar" class="header-editor-toolbar hidden">
              <div class="toolbar-group">
                  <label for="font-family-select">Schriftart:</label>
                  <select id="font-family-select"></select>
              </div>
              <div class="toolbar-group">
                  <label for="font-size-input">Größe:</label>
                  <input type="number" id="font-size-input" min="10" max="100" />
              </div>
          </div>

          <div class="sheet-music" id="sheet-music">
            <!-- Sheet content will be generated by JavaScript -->
          </div>
        </div>
      </main>
      
      <button id="add-line-btn" class="app-button add-line-button">
        Neue Zeile
      </button>
      <button id="help-btn" class="app-button help-button">
        ?
      </button>
      <button id="print-pdf-btn" class="app-button print-button">
        Drucken / PDF
      </button>
      <button id="export-png-btn" class="app-button export-button">
        Export als PNG
      </button>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            <h2>Hilfe & Anleitung</h2>
            <p><strong>Allgemeine Bedienung:</strong> Alle Elemente auf dem Notenblatt können direkt angeklickt werden, um sie zu bearbeiten. Ein Klick außerhalb des Elements speichert die Änderung.</p>
            
            <dl>
                <dt>Kopfzeile (Titel, etc.)</dt>
                <dd>Klicken Sie auf "Titel", "Untertitel" oder "Stil", um den Text zu ändern. Während der Bearbeitung erscheint oben eine Werkzeugleiste, mit der Sie die <strong>Schriftart</strong> und <strong>Schriftgröße</strong> anpassen können.</dd>
                
                <dt>Taktart</dt>
                <dd>Klicken Sie auf die Taktart (z.B. <code>4/4</code>) am Anfang des Blattes, um sie zu ändern. Die Anzahl der Eingabefelder pro Takt passt sich automatisch an die neue Taktart an (z.B. bei <code>3/4</code> werden 3 Felder angezeigt).</dd>

                <dt>Struktur bearbeiten</dt>
                <dd>
                  <ul>
                    <li><strong>Neue Zeile hinzufügen:</strong> Klicken Sie auf den Button "Neue Zeile" unten links.</li>
                    <li><strong>Zeile löschen:</strong> Klicken Sie auf das große "×" am Ende einer Zeile. Dieser Knopf erscheint nur, wenn es mehr als eine Zeile gibt.</li>
                    <li><strong>Takt hinzufügen:</strong> Wenn eine Zeile weniger als vier Takte hat, erscheint am Ende der Zeile ein <code>+</code> Knopf, um einen neuen Takt hinzuzufügen.</li>
                    <li><strong>Takt löschen:</strong> Fahren Sie mit der Maus über einen Takt und klicken Sie auf das kleine "×" oben rechts. Dieser Knopf erscheint nur, wenn eine Zeile mehr als einen Takt hat.</li>
                  </ul>
                </dd>

                <dt>Inhalt bearbeiten</dt>
                <dd>
                  <ul>
                    <li><strong>Zeilentext:</strong> Klicken Sie in den leeren Bereich über einer Notenzeile, um Anmerkungen wie "Intro", "Verse" oder "Chorus" hinzuzufügen. Die Textausrichtung kann gesteuert werden:
                        <ul>
                            <li><code>&lt;Verse</code>: Linksbündig</li>
                            <li><code>&gt;Chorus</code>: Rechtsbündig</li>
                            <li><code>Intro</code>: Zentriert (Standard)</li>
                        </ul>
                         Zusätzlich werden folgende musikalische Symbole automatisch erkannt (Groß-/Kleinschreibung egal):
                        <ul>
                            <li><code>$</code>: Wird zum Segno-Zeichen (𝄋).</li>
                            <li><code>Coda</code>: Wird zum Coda-Zeichen (𝄌).</li>
                            <li><code>D.S.</code>: Wird zum Dal-Segno-Zeichen (𝄉).</li>
                            <li><code>D.C.</code>: Wird zum Da-Capo-Zeichen (𝄊).</li>
                        </ul>
                    </li>
                    <li><strong>Akkorde im Takt:</strong> Klicken Sie in einen Takt, um die Eingabefelder für die Akkorde anzuzeigen.
                        <ul>
                            <li>Geben Sie Akkordsymbole ein (z.B. <code>C</code>, <code>Gm7</code>, <code>D/F#</code>).</li>
                            <li>Benutzen Sie einen Schrägstrich <code>/</code> für einen Taktschlag.</li>
                            <li>Geben Sie <code>%</code> in ein beliebiges Feld ein, um ein Taktwiederholungszeichen (Faulenzer) anzuzeigen.</li>
                            <li>Lassen Sie ein Feld leer für eine Pause auf diesem Schlag.</li>
                        </ul>
                    </li>
                    <li><strong>Endings (Volta-Klammern):</strong> Klicken Sie in den leeren Bereich <strong>über</strong> einem Takt, um eine Klammer für eine 1. oder 2. Endung hinzuzufügen. Geben Sie den Text ein (z.B. <code>1.</code> oder <code>2.</code>). Wenn benachbarte Takte denselben Text haben, werden die Klammern automatisch zu einer längeren Klammer verbunden. Um eine Klammer zu entfernen, leeren Sie einfach den Text.</li>
                    <li><strong>Taktstriche:</strong> Klicken Sie auf einen Taktstrich, um ihn zu bearbeiten. Geben Sie eines der folgenden Symbole ein:
                        <ul>
                           <li><code>|</code> : Normaler Taktstrich</li>
                           <li><code>||</code> : Doppelter Taktstrich</li>
                           <li><code>|&lt;</code> : Anfangs-Wiederholungszeichen</li>
                           <li><code>&gt;|</code> oder <code>}</code> : End-Wiederholungszeichen</li>
                           <li><code>|||</code> : Schlussstrich</li>
                        </ul>
                    </li>
                  </ul>
                </dd>

                <dt>Export & Druck - Perfekt optimiert</dt>
                <dd>
                    <ul>
                        <li><strong>Drucken / PDF:</strong> Erstellt eine professionell formatierte, druckoptimierte Version mit:
                            <ul>
                                <li>Automatischen, intelligenten Seitenumbrüchen</li>
                                <li>Konsistenten Schriftgrößen für optimale Lesbarkeit</li>
                                <li>Präzisen Rändern und Abständen</li>
                                <li>Perfekter Darstellung aller musikalischen Symbole</li>
                                <li>Sauberen Taktstrichen und Volta-Klammern</li>
                                <li>Seitenzahlen bei mehrseitigen Dokumenten</li>
                            </ul>
                        </li>
                        <li><strong>Export als PNG:</strong> Speichert das Notenblatt als hochauflösende, druckreife Bilddatei(en). Bei mehrseitigen Dokumenten wird für jede Seite eine separate PNG-Datei erstellt. Alle interaktiven Elemente werden automatisch ausgeblendet für eine saubere Darstellung.</li>
                    </ul>
                </dd>
            </dl>
        </div>
    </div>

    <script type="module">
      // Verbesserte Konstanten für bessere Druckausgabe
      const BAR_SYMBOLS = { 
        '|': 'single', 
        '||': 'double', 
        '|||': 'final', 
        '>|': 'end', 
        '}': 'end', 
        '|<': 'start-repeat' 
      };
      
      const SYMBOL_LOOKUP = {
          'single': '|',
          'double': '||',
          'final': '|||',
          'end': '>|',
          'start-repeat': '|<'
      };

      const GOOGLE_FONTS = [
          { name: 'Times New Roman', family: "'Times New Roman', Times, serif" },
          { name: 'Merriweather', family: "'Merriweather', serif" },
          { name: 'Roboto', family: "'Roboto', sans-serif" },
          { name: 'Playfair Display', family: "'Playfair Display', serif" },
          { name: 'Dancing Script', family: "'Dancing Script', cursive" },
          { name: 'Caveat', family: "'Caveat', cursive" },
      ];

      // Optimierter State für bessere Print-Performance
      const state = {
        sheetData: {
          title: 'Titel hier klicken',
          titleFont: { family: "'Times New Roman', Times, serif", size: 40 },
          subtitle: 'Untertitel hier klicken',
          subtitleFont: { family: "'Times New Roman', Times, serif", size: 19 },
          style: '(Stil hier klicken)',
          styleFont: { family: "'Times New Roman', Times, serif", size: 19 },
          timeSignature: '4/4',
          lines: [
            {
              lineText: '<Klicken zum Bearbeiten des Zeilentextes',
              startBar: 'single',
              measures: [
                { beats: ['', '', '', ''], barLine: 'single', volta: '', rehearsalMark: '' },
                { beats: ['', '', '', ''], barLine: 'single', volta: '', rehearsalMark: '' },
                { beats: ['', '', '', ''], barLine: 'single', volta: '', rehearsalMark: '' },
                { beats: ['', '', '', ''], barLine: 'final', volta: '', rehearsalMark: '' }
              ],
            }
          ]
        },
        editing: null,
        isExporting: false,
      };

      // DOM Element References mit verbesserter Error-Handling
      const dom = {
        exportButton: document.getElementById('export-png-btn'),
        printPdfButton: document.getElementById('print-pdf-btn'),
        addLineButton: document.getElementById('add-line-btn'),
        sheetMusicContainer: document.getElementById('sheet-music'),
        sheetPanel: document.querySelector('.sheet-panel'),
        appContainer: document.querySelector('.app-container'),
        helpButton: document.getElementById('help-btn'),
        helpModal: document.getElementById('help-modal'),
        modalCloseButton: document.getElementById('modal-close-btn'),
        headerToolbar: document.getElementById('header-editor-toolbar'),
        fontFamilySelect: document.getElementById('font-family-select'),
        fontSizeInput: document.getElementById('font-size-input'),
      };

      // --- HELPERS ---
      const getBeatsPerMeasure = () => {
          const [beats] = String(state.sheetData.timeSignature).split('/').map(s => parseInt(s, 10));
          return !isNaN(beats) && beats > 0 ? beats : 4;
      };

      // Verbesserte Chord-Element-Erstellung
      const createChordElement = (chord) => {
          const chordDisplay = document.createElement('div');
          chordDisplay.className = 'chord-display';
          if (!chord) return chordDisplay;

          if (chord.trim() === '/') {
              const slash = document.createElement('span');
              slash.className = 'beat-slash';
              slash.textContent = '\uD834\uDD0D'; // MUSICAL SYMBOL REPEAT SIGN
              return slash;
          }

          const [mainChordStr, bassNote] = chord.split('/');
          const mainSpan = document.createElement('span');
          mainSpan.className = 'chord-main';

          const match = mainChordStr.match(/^([A-G])([#b]?)(.*)/);
          if (!match) {
              mainSpan.textContent = mainChordStr;
          } else {
              const [, rootNote, accidental, extension] = match;
              
              const rootSpan = document.createElement('span');
              if (bassNote) {
                  rootSpan.className = 'chord-root-slash';
              }
              rootSpan.textContent = rootNote;
              mainSpan.appendChild(rootSpan);

              if (accidental) {
                  const accidentalSpan = document.createElement('span');
                  accidentalSpan.className = 'chord-accidental';
                  let musicalSymbol = accidental;
                  if (accidental === '#') {
                      musicalSymbol = '♯';
                  } else if (accidental === 'b') {
                      musicalSymbol = '♭';
                      accidentalSpan.classList.add('is-flat');
                  }
                  accidentalSpan.textContent = musicalSymbol;
                  mainSpan.appendChild(accidentalSpan);
              }
              
              if (extension) {
                  const extSpan = document.createElement('span');
                  extSpan.className = 'chord-extension';
                  if (bassNote) {
                      extSpan.classList.add('is-slash-extension');
                  }
                  extSpan.textContent = extension;
                  mainSpan.appendChild(extSpan);
              }
          }
          chordDisplay.appendChild(mainSpan);

          if (bassNote) {
              const slashSeparator = document.createElement('span');
              slashSeparator.textContent = '/';
              chordDisplay.appendChild(slashSeparator);

              const bassSpan = document.createElement('span');
              bassSpan.className = 'chord-bass';
              bassSpan.textContent = bassNote;
              chordDisplay.appendChild(bassSpan);
          }
          return chordDisplay;
      };

      const applyFontStyles = (element, fontData) => {
          element.style.fontFamily = fontData.family;
          element.style.fontSize = `${fontData.size}px`;
      };

      // Optimierte Sheet-Rendering-Funktion
      const renderSheet = () => {
          dom.sheetMusicContainer.innerHTML = '';
          const data = state.sheetData;
          const beatsPerMeasure = getBeatsPerMeasure();
          
          // Header Toolbar Management
          dom.headerToolbar.classList.add('hidden');
          if (state.editing?.type === 'header') {
              const part = state.editing.part;
              const fontData = data[`${part}Font`];
              if (fontData) {
                  dom.fontFamilySelect.value = fontData.family;
                  dom.fontSizeInput.value = String(fontData.size);
                  dom.headerToolbar.classList.remove('hidden');
              }
          }

          // Header Rendering mit verbesserter Print-Kompatibilität
          const header = document.createElement('div');
          header.className = 'sheet-header';
          
          const isEditingTitle = state.editing?.type === 'header' && state.editing.part === 'title';
          const titleEl = isEditingTitle ? document.createElement('input') : document.createElement('h1');
          applyFontStyles(titleEl, data.titleFont);
          if (isEditingTitle) {
              titleEl.type = 'text';
              titleEl.value = data.title;
              titleEl.className = 'header-input title-input';
          } else {
              titleEl.textContent = data.title;
          }
          titleEl.dataset.part = 'title';
          header.appendChild(titleEl);
          
          const secondLine = document.createElement('div');
          secondLine.className = 'header-second-line';
          
          const isEditingStyle = state.editing?.type === 'header' && state.editing.part === 'style';
          const styleEl = isEditingStyle ? document.createElement('input') : document.createElement('div');
          applyFontStyles(styleEl, data.styleFont);
          if (isEditingStyle) {
              styleEl.type = 'text';
              styleEl.value = data.style;
              styleEl.className = 'header-input';
              styleEl.style.fontFamily = data.styleFont.family;
          } else {
              styleEl.textContent = data.style;
              styleEl.className = 'style-info';
          }
          styleEl.dataset.part = 'style';
          secondLine.appendChild(styleEl);

          const isEditingSubtitle = state.editing?.type === 'header' && state.editing.part === 'subtitle';
          const subtitleEl = isEditingSubtitle ? document.createElement('input') : document.createElement('div');
          applyFontStyles(subtitleEl, data.subtitleFont);
          if (isEditingSubtitle) {
              subtitleEl.type = 'text';
              subtitleEl.value = data.subtitle;
              subtitleEl.className = 'header-input subtitle-input';
              subtitleEl.style.fontFamily = data.subtitleFont.family;
          } else {
              subtitleEl.textContent = data.subtitle;
              subtitleEl.className = 'subtitle-info';
          }
          subtitleEl.dataset.part = 'subtitle';
          secondLine.appendChild(subtitleEl);

          header.appendChild(secondLine);
          dom.sheetMusicContainer.appendChild(header);

          // Body Rendering
          const sheetBody = document.createElement('div');
          sheetBody.className = 'sheet-body';

          const isEditingTime = state.editing?.type === 'timeSignature';
          const timeEl = document.createElement('div');
          timeEl.className = 'time-signature';
          if(isEditingTime) {
              const input = document.createElement('input');
              input.type = 'text';
              input.value = data.timeSignature;
              input.className = 'time-signature-input';
              timeEl.appendChild(input);
          } else {
              const [num, den] = data.timeSignature.split('/');
              timeEl.innerHTML = `<span>${num || ''}</span><span>${den || ''}</span>`;
          }
          sheetBody.appendChild(timeEl);
          
          const measuresContainer = document.createElement('div');
          measuresContainer.className = 'measures-container';
          
          data.lines.forEach((lineData, lineIndex) => {
              const lineWrapper = document.createElement('div');
              lineWrapper.className = 'line-wrapper';

              // Line Text Rendering mit verbesserter Symbol-Erkennung
              const isEditingLineText = state.editing?.type === 'lineText' && state.editing.lineIndex === lineIndex;
              const lineTextContainer = document.createElement('div');
              lineTextContainer.className = 'line-text-container';
              lineTextContainer.dataset.lineIndex = String(lineIndex);
              
              if (isEditingLineText) {
                  const input = document.createElement('input');
                  input.type = 'text';
                  input.className = 'line-text-input';
                  input.value = lineData.lineText || '';
                  lineTextContainer.appendChild(input);
              } else {
                  const display = document.createElement('div');
                  display.className = 'line-text-display';
                  
                  const rawText = lineData.lineText || '';
                  let textToParse = rawText;
                  let alignment = 'align-center'; 

                  if (rawText.startsWith('<')) {
                      textToParse = rawText.substring(1);
                      alignment = 'align-left';
                  } else if (rawText.startsWith('>')) {
                      textToParse = rawText.substring(1);
                      alignment = 'align-right';
                  }
                  
                  display.classList.add(alignment);

                  // Verbesserte musikalische Symbol-Erkennung
                  const fragments = textToParse.split(/(D\\.S\\.|D\\.C\\.|Coda|\\$)/ig);

                  fragments.forEach(fragment => {
                      if (!fragment) return;
                      
                      const lowerFragment = fragment.toLowerCase().trim();
                      let symbolSpan;

                      switch (lowerFragment) {
                          case ':
                              symbolSpan = document.createElement('span');
                              symbolSpan.className = 'musical-symbol segno-symbol';
                              symbolSpan.textContent = '\uD834\uDD0B'; // Segno
                              display.appendChild(symbolSpan);
                              break;
                          case 'coda':
                              symbolSpan = document.createElement('span');
                              symbolSpan.className = 'musical-symbol coda-symbol';
                              symbolSpan.textContent = '\uD834\uDD0C'; // Coda
                              display.appendChild(symbolSpan);
                              break;
                          case 'd.s.':
                              symbolSpan = document.createElement('span');
                              symbolSpan.className = 'musical-symbol ds-symbol';
                              symbolSpan.textContent = '\uD834\uDD09'; // Dal Segno
                              display.appendChild(symbolSpan);
                              break;
                          case 'd.c.':
                              symbolSpan = document.createElement('span');
                              symbolSpan.className = 'musical-symbol dc-symbol';
                              symbolSpan.textContent = '\uD834\uDD0A'; // Da Capo
                              display.appendChild(symbolSpan);
                              break;
                          default:
                              display.appendChild(document.createTextNode(fragment));
                      }
                  });
                  lineTextContainer.appendChild(display);
              }
              lineWrapper.appendChild(lineTextContainer);
              
              const lineEl = document.createElement('div');
              lineEl.className = 'measure-line';

              // Start Bar Rendering
              const isEditingStartBar = state.editing?.type === 'startBar' && state.editing.lineIndex === lineIndex;
              const startBarContainer = document.createElement('div');
              startBarContainer.className = 'bar-line-container';
              startBarContainer.dataset.lineIndex = String(lineIndex);
              startBarContainer.dataset.type = 'startBar';

              if (isEditingStartBar) {
                  const barInput = document.createElement('input');
                  barInput.type = 'text';
                  barInput.className = 'bar-line-input';
                  barInput.value = SYMBOL_LOOKUP[lineData.startBar] || '|';
                  startBarContainer.appendChild(barInput);
              } else {
                  const barLineEl = document.createElement('div');
                  barLineEl.classList.add('bar-line-display', `bar-${lineData.startBar}`);
                  if (lineData.startBar === 'start-repeat') {
                      barLineEl.innerHTML = '<div class="start-repeat-dots">:</div>';
                  }
                  startBarContainer.appendChild(barLineEl);
              }
              lineEl.appendChild(startBarContainer);

              // Measures and Bar Lines Rendering
              lineData.measures.forEach((measure, measureIndex) => {
                  const isEditingMeasure = state.editing?.type === 'measure' && state.editing.lineIndex === lineIndex && state.editing.measureIndex === measureIndex;
                  const measureEl = document.createElement('div');
                  measureEl.className = 'measure';
                  measureEl.dataset.lineIndex = String(lineIndex);
                  measureEl.dataset.measureIndex = String(measureIndex);
                  
                  // Measure Delete Button
                  if (lineData.measures.length > 1) {
                      const deleteBtn = document.createElement('button');
                      deleteBtn.className = 'measure-delete-btn';
                      deleteBtn.textContent = '×';
                      deleteBtn.dataset.lineIndex = String(lineIndex);
                      deleteBtn.dataset.measureIndex = String(measureIndex);
                      deleteBtn.setAttribute('aria-label', `Takt ${measureIndex + 1} löschen`);
                      measureEl.appendChild(deleteBtn);
                  }

                  // Rehearsal Mark Logic
                  const isEditingRehearsalMark = state.editing?.type === 'rehearsalMark' && state.editing.lineIndex === lineIndex && state.editing.measureIndex === measureIndex;
                  if (isEditingRehearsalMark || measure.rehearsalMark) {